name: Kernel Module Build

on:
  push:
    branches: [master]
    paths:
      - 'linux/**'
      - 'common/**'
  pull_request:
    branches: [master]
    paths:
      - 'linux/**'
      - 'common/**'

jobs:
  build-kernel-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kernel headers and build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            linux-headers-$(uname -r) build-essential bc kmod

      - name: Build kernel module
        run: make -C linux

      - name: Verify pool.ko
        run: |
          test -f linux/pool.ko
          modinfo linux/pool.ko

      - name: Build userspace tools
        run: make -C linux tools

      - name: Build bridge
        run: make -C bridge

      - name: Build shim
        run: make -C shim

      - name: Build relay
        run: make -C relay

      - name: Build vault
        run: make -C vault

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pool-build
          path: |
            linux/pool.ko
            linux/poolctl
            linux/poold
            linux/pool_test
            bridge/pool_bridge
            bridge/pool_migrate
            shim/libpool_shim.so
            relay/pool_relay
            vault/pool_vault
